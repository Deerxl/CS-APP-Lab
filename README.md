# CS-APP-Lab
three labs, data lab, bomb lab, attack lab.

<!-- TOC -->

- [CS-APP-Lab](#cs-app-lab)
    - [Data Lab](#data-lab)
        - [实验介绍](#实验介绍)
        - [实验内容](#实验内容)
        - [示例](#示例)
        - [实验要求](#实验要求)
        - [平台与语言](#平台与语言)
        - [实验数据](#实验数据)
        - [说明](#说明)
        - [检查](#检查)
    - [Bomb Lab](#bomb-lab)
        - [实验介绍](#实验介绍-1)
        - [二进制炸弹](#二进制炸弹)
        - [拆弹](#拆弹)
        - [自动评分系统](#自动评分系统)
        - [实验环境说明](#实验环境说明)
            - [平台与语言](#平台与语言-1)
            - [可能有用的工具](#可能有用的工具)
        - [说明](#说明-1)
        - [实验步骤提示](#实验步骤提示)
        - [实验结果的提交](#实验结果的提交)
    - [Attack Lab](#attack-lab)
        - [实验介绍](#实验介绍-2)
        - [实验环境说明](#实验环境说明-1)
            - [平台与语言](#平台与语言-2)
        - [说明](#说明-2)
        - [实验结果的提交](#实验结果的提交-1)
    - [参考网址](#参考网址)
    - [补充](#补充)

<!-- /TOC -->

## Data Lab
### 实验介绍
这个实验帮助学生练习和掌握整型和浮点型数据的二进制表示及基本运算。在这个实验中，学生需要修改一个名为bits.c的C文件。该文件中包含多个空的方法体。学生需要在这些方法体中填写代码，使得每个方法都能够分别实现一个特定的数学函数，比如“绝对值”。在实现过程中，还有一些别的约束。比如，整型函数的实现中，学生只能使用顺序执行的C代码和限定的算术及逻辑操作符。

学生使用下列三种工具来说检查他们的工作；教师使用同样的工具来评估。
* dlc：“data lab compiler”，该工具用于检查学生的代码实现是否满足指定的约束。
* btest：该工具用于检查学生的代码实现是否正确。
* driver.pl：这是一个驱动程序，能够调用dlc和btest来检查学生的代码实现，并自动评分。
### 实验内容
你需要完成bits.c文件中所有function框架的实现，以满足该function对应注释所要求的功能需求和编程约束。
### 示例
```
                /*
                bitAnd - x&y using only ~ and |
                Example: bitAnd(6, 5) = 4
                Legal ops: ~ |
                Max ops: 8
                Rating: 1
                */
                
                int bitAnd(int x, int y) {
                return 0;
                }
```                
Function框架前的注释描述了该function所要实现的功能，以及编程约束。就上述例子而言：
* 功能：实现 x&y
* Example：该function测试用例的示例
* Legal ops：允许使用的C语言操作符仅为~和|
* Max ops：允许使用的操作符的总个数的上限
* Rating：该function的难度等级，也是该function对应的分值
* 实验任务：将函数体中的“return 0；”修改成具体的代码段，以实现功能需求和编程约束。
### 实验要求
除了function框架前的注释，还有一些通用的约束（请认真阅读bits.c文件中的注释要求），比如：

**整型函数**
* 不能使用控制结构，比如if, do, while, for, switch等等。
* 不能使用宏。
* 不能定义新的函数。
* 不能调用别的函数。
* 不能使用别的运算符，比如：&&，||, -, ?:等等。
* 不能使用类型转换。
* 不能使用数组、结构、联合类型。
* 不能使用全局变量。
* 整型字面常量不能超过[0, 255]的范围。

**浮点型函数**
* 不能使用宏。
* 不能定义新的函数。
* 不能调用其他函数。
* 不能使用类型转换。
* 不能使用数组、结构和联合类型。
* 不能使用所有的浮点类型和浮点运算符。

### 平台与语言
C语言

Linux

**说明：**

data-lab实验在32位机器上不需要修改，在64位机器上需要修改Makefile（后文有说明）；其余实验可以在64位机器上正常运行。

建议安装虚拟机或者尝试WSL（Windows Subsystem for Linux）。

### 实验数据
实验所需的文件和代码都在一个压缩文件:datalab-handout.tar中，解压缩后，其目录如下:
* README: 实验说明文件，请在开始实验前仔细阅读。
* Makefile: 生成btest、fshow、ishow等相关工具的Makefile文件。
* bits.c: 学生需要修改的文件，包含一系列用于完成指定功能的function的代码框架。每个function框架前面有详细的注释，这些注释说明了实现该框架的具体要求。学生需要根据这些要求实现每个function框架。
* bits.h: bits.c所需头文件，不需要修改。
* btest.h, decl.c, tests.c, btest.c：用于生成btest工具，该工具用于测试实验结果是否满足功能正确。
* ishow.c: 用于生成ishow工具，该工具查看整型数据的二进制表示。
* fshow.c：用于生成fshow工具，该工具查看浮点数据的二进制表示。
* driver.pl: 该工具调用dlc和btest，对bits.c自动评分。提交之前可以据此提前预知自己的分数。
### 说明

Makefile默认生成目标平台为32位机器y，如果实验平台为64位机器，需要将Makefile中的CFLAGS选项“-m32”修改为“-m64”。

### 检查
下列命令检查bits.c是否满足编程约束：
>./dlc bits.c

下列命令可以打印出每个函数使用的操作符数目：
>./dlc -e bits.c

下列命令可以查看更多命令选项：
>./dlc -h

下列命令编译生成btest工具：
>make

下列命令检查bits.c中所有函数的功能正确性：
>./btest

btest工具有很多别的选项，可以辅助学生调试自己的方法。比如，下列命令只测试函数bitXor，并且指定输入的两个参数为7和0xf，该命令会返回相应信息。
>./btest -f bitXor -1 7 -2 -xf 

说明：**每次修改bits.c后，需要利用make重新生成btest工具。**

下列命令会自动调用dlc和btest，同时考虑运行性能，从而评估得分。
>./driver.pl

## Bomb Lab
### 实验介绍
这个实验帮助学生练习和掌握机器级程序的基本原理，以及一些通用的调试和反向工程技巧。

### 二进制炸弹
实验中，一个“二进制炸弹”是指一个Linux下的可执行程序，包含六个关口。每个关口需要学生从控制台（stdin）输入一个猜测的特定的字符串（可以理解为拆弹密钥）。如果猜对了，则拆弹成功；如果猜错了，则炸弹爆炸并输出“BOOM!!!”。学生的目标是尽可能多次拆弹成功。

每个炸弹关口从不同角度考察机器语言程序：

* 第1关：字符串比较
* 第2关：循环
* 第3关：条件/开关
* 第4关：递归调用和栈约定
* 第5关：指针
* 第6关：链接表/指针/结构类型
越往后的关口，炸弹越难拆除。并且，如果学生在第4关的密码后面加上一个特定字符串的话，还可以开启一个隐藏的副本关口。

每个关口有三个不同的副本：‘a’，‘b’， 和‘c’。每个学生在每个关口会获得一个随机副本。并且，绝大部分关口副本都会在创建时引入一个随机常量，保证每个学生获得一个唯一炸弹，必须独立完成拆弹。

### 拆弹
在拆弹过程中，学生需要使用调试器，比如gdb或者ddd，来反汇编二进制并且单步执行二进制码，通过理解每条汇编指令的用意来推测拆弹密码。拆弹成功会加分，失败会扣分。

### 自动评分系统
学生从服务器下载自己唯一的炸弹程序，在拆弹过程中，每次拆弹成功或者失败都会实时传回给服务器，并在服务器上的计分板页面实时反映当前炸弹的结果（暂时积分版页面实时更新功能失效）。

### 实验环境说明
#### 平台与语言
Linux

C语言、汇编语言
#### 可能有用的工具
Gdb

GNU 发布的调试工具。为了从炸弹程序中找出触发炸弹爆炸的条件，可以借助gdb来对二进制程序进行分析。
1. 加载、启动待调试的二进制文件。
2. 设置断点。
3. 查看反汇编代码、程序变量、寄存器、栈内容等。
4. 动态改变程序的执行环境，如修改变量的值。
* objdump
* * 查看二进制文件的符号表（包括函数、全局变量的名称和地址）
* * 查看二进制文件的反汇编。
* strings
* * 显示二进制文件中的可打印字符串。
 
### 说明
* bomb：二进制可执行炸弹程序。
* bomb.c：二进制炸弹对应的main函数的内容，可以看成一个辅助拆弹过程的提示。
* README：说明该实验数据包绑定到哪位学生。

### 实验步骤提示
> objdump -d bomb > disassemble.txt
   
   上述命令可以获得二进制炸弹bomb的反汇编代码。通过查看反汇编文件中的main函数，可以找到对应第一个关卡的函数名。接下来在反汇编文件中找到该函数对应的代码。在其中可以找到对应的指令。对于第一关（字符串比较）来说，是一个字符串相关的函数调用指令（call strings_not_equal）。利用第三章的知识，确定参与比较的两个参数的存储位置。猜测是一个存在代码中，一个通过从标准输入读取（即学生输入的密码字符串）。通过找到代码中存储的字符串，就可以推测出第一关的密码。

### 实验结果的提交
如果学生在拆弹过程中保持联网，则不需要提交实验结果。学生在拆弹过程中，bomb程序每次发生拆弹成功或失败都会将信息反馈到服务器记录，并实时更新当前得分状况。

## Attack Lab
### 实验介绍
这个实验帮助学生练习和掌握栈的使用约定，并让他们深刻体会如果代码中存在缓冲区漏洞会导致怎样的风险。实验中为每个学生提供了两个定制的二进制文件。其中一个很容易被代码注入攻击，另一个很容易被基于return的编程方法攻击。学生的任务就是利用这两种攻击思路，设计程序输入，以实现缓冲区漏洞攻击。

### 实验环境说明
#### 平台与语言
x86-64 Linux

Gcc (4.8.1以后版本)

可能有用的工具

gdb

objdump

### 说明

每个请求的实验数据包绑定到一个特定的学号，实验进行过程中会自动计算该学号的得分，所以请务必使用自己的数据包。

如果实验数据包丢失，可以重新输入学号和邮箱地址获取。
实验数据

实验数据包为一个压缩文件targetN.tar。解压缩后，里面有三个文件：

* ctarget: 一个有代码注入攻击漏洞的二进制文件。
* rtarget: 一个有return-oriented攻击漏洞的二进制文件。
* cookie.txt:
* farm.c: 用于return-oriented编程攻击的源代码。
* hex2raw: 用于生成攻击字符串的工具。
* README：说明该实验数据包绑定到哪位学生。

### 实验结果的提交
如果学生在攻击过程中保持联网，则不需要提交实验结果。学生在攻击过程中，target程序会自动将信息反馈到服务器记录，并实时更新当前得分状况。

## 参考网址
[Computer Systems: A Programmer's Perspective, 3/E (CS:APP3e)](http://csapp.cs.cmu.edu/)

[实验说明](http://csapp.cs.cmu.edu/3e/labs.html)

## 补充
一些实验帮助和说明可见resource文件夹